{"ast":null,"code":"import _objectSpread from\"C:/Users/PERSONAL/Downloads/tugood tugo/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{useNavigate}from'react-router-dom';import{ArrowLeft,Package,Clock,MapPin,CheckCircle,AlertCircle,Shield,QrCode}from'lucide-react';import{pedidosAPI,authAPI}from'../services/api';import{createQRData,generateVerificationURL}from'../utils/qrUtils';import'../styles/ActiveOrders.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const ActiveOrders=()=>{const[pedidos,setPedidos]=useState([]);const[loading,setLoading]=useState(true);const navigate=useNavigate();// Función para generar código de seguridad\nconst generateSecurityCode=()=>{return Math.random().toString(36).substring(2,8).toUpperCase();};useEffect(()=>{const cargarPedidos=async()=>{try{setLoading(true);// 1. Verificar autenticación\nconst user=authAPI.getCurrentUser();const token=authAPI.getToken();console.log('🔍 Estado de autenticación:',{usuario:user?'Autenticado':'No autenticado',userId:user===null||user===void 0?void 0:user.id,tokenPresente:!!token,tokenLength:token===null||token===void 0?void 0:token.length});if(!token||!user){console.warn('🔒 Usuario no autenticado. Creando datos de prueba...');// En lugar de redirigir, crear datos de prueba para demostración\nconst pedidosPrueba=[{id:'demo-1',comercio_nombre:'Panadería San José',cantidad_packs:2,estado:'confirmado',total:24000,fecha_recogida:new Date(Date.now()+2*60*60*1000).toISOString(),// 2 horas desde ahora\nitems:[{nombre:'Pack Sorpresa Panadería',cantidad:2,precio:12000}],codigo_seguridad:generateSecurityCode(),direccion_comercio:'Carrera 15 #93-47, Chapinero',telefono_comercio:'+57 301 234 5678'},{id:'demo-2',comercio_nombre:'Restaurante El Buen Sabor',cantidad_packs:1,estado:'listo',total:15000,fecha_recogida:new Date(Date.now()+1*60*60*1000).toISOString(),// 1 hora desde ahora\nitems:[{nombre:'Pack Almuerzo Sorpresa',cantidad:1,precio:15000}],codigo_seguridad:generateSecurityCode(),direccion_comercio:'Calle 85 #12-34, Zona Rosa',telefono_comercio:'+57 302 345 6789'}];console.log('📦 Usando datos de prueba:',pedidosPrueba);setPedidos(pedidosPrueba);setLoading(false);return;}// 2. Hacer la petición a la API usando el servicio pedidosAPI\nconsole.log('🔄 Solicitando pedidos activos...');const response=await pedidosAPI.getList({estado:'pendiente'});// 3. Procesar la respuesta\nconsole.log('📦 Respuesta de la API:',response);// Extraer los pedidos de la respuesta (manejar diferentes formatos)\nlet pedidosData=[];if(Array.isArray(response)){pedidosData=response;}else if(response&&Array.isArray(response.pedidos)){pedidosData=response.pedidos;}else if(response&&Array.isArray(response.data)){pedidosData=response.data;}else if(response){console.warn('⚠️ Formato de respuesta inesperado:',response);}console.log(\"\\uD83D\\uDCCA \".concat(pedidosData.length,\" pedidos encontrados\"));// Si no hay pedidos de la API, usar datos de prueba\nif(pedidosData.length===0){console.log('📝 No hay pedidos en la API, usando datos de prueba...');const pedidosPrueba=[{id:'api-demo-1',comercio_nombre:'Café Central',cantidad_packs:1,estado:'pendiente',total:18000,fecha_recogida:new Date(Date.now()+3*60*60*1000).toISOString(),items:[{nombre:'Pack Café y Pastelería',cantidad:1,precio:18000}]}];setPedidos(pedidosPrueba);}else{// 4. Validar y formatear los pedidos\nconst pedidosValidados=pedidosData.map((pedido,index)=>_objectSpread(_objectSpread({id:pedido.id||\"temp-\".concat(index,\"-\").concat(Date.now())},pedido),{},{notas:pedido.notas||'',estado:pedido.estado||'pendiente',fecha:pedido.fecha||new Date().toISOString(),total:pedido.total||0,comercio_nombre:pedido.comercio_nombre||'Comercio desconocido',cantidad_packs:pedido.cantidad_packs||1,fecha_recogida:pedido.fecha_recogida||new Date(Date.now()+2*60*60*1000).toISOString(),// Asegurar que los items sean un array\nitems:Array.isArray(pedido.items)?pedido.items:[]}));console.log('✅ Pedidos procesados:',pedidosValidados);setPedidos(pedidosValidados);}}catch(error){console.error('❌ Error al cargar pedidos:',error);// En caso de error, mostrar datos de prueba para que la pantalla no esté vacía\nconsole.log('🔄 Error en API, usando datos de prueba como fallback...');const pedidosFallback=[{id:'fallback-1',comercio_nombre:'Supermercado Fresh',cantidad_packs:1,estado:'confirmado',total:20000,fecha_recogida:new Date(Date.now()+4*60*60*1000).toISOString(),items:[{nombre:'Pack Frutas y Verduras',cantidad:1,precio:20000}]}];setPedidos(pedidosFallback);// No mostrar error al usuario, solo en consola\nconsole.warn('Usando datos de demostración debido a error en la API');}finally{setLoading(false);}};cargarPedidos();},[navigate]);const handleVerDetalle=pedido=>{var _authAPI$getCurrentUs;// Crear datos para el QR\nconst qrData=createQRData({id:pedido.id,comercio_nombre:pedido.comercio_nombre,total:pedido.total,codigo_seguridad:pedido.codigo_seguridad,cliente_nombre:((_authAPI$getCurrentUs=authAPI.getCurrentUser())===null||_authAPI$getCurrentUs===void 0?void 0:_authAPI$getCurrentUs.nombre)||'Cliente',items:pedido.items,comercio_direccion:pedido.direccion_comercio,comercio_telefono:pedido.telefono_comercio});// Generar URL de verificación\nconst verificationURL=generateVerificationURL(qrData);// Abrir en nueva ventana/pestaña\nwindow.open(verificationURL,'_blank','width=800,height=900,scrollbars=yes,resizable=yes');};const handleCopySecurityCode=async codigo=>{try{await navigator.clipboard.writeText(codigo);alert(\"\\u2705 C\\xF3digo \".concat(codigo,\" copiado al portapapeles\"));}catch(error){console.error('Error copying to clipboard:',error);// Fallback para navegadores que no soportan clipboard API\nconst textArea=document.createElement('textarea');textArea.value=codigo;document.body.appendChild(textArea);textArea.select();document.execCommand('copy');document.body.removeChild(textArea);alert(\"\\u2705 C\\xF3digo \".concat(codigo,\" copiado al portapapeles\"));}};if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"active-orders-screen\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"loading-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Cargando tus pedidos...\"})]})});}const getStatusIcon=estado=>{switch(estado){case'confirmado':return/*#__PURE__*/_jsx(CheckCircle,{size:16,className:\"status-icon confirmed\"});case'listo':return/*#__PURE__*/_jsx(Package,{size:16,className:\"status-icon ready\"});case'pendiente':return/*#__PURE__*/_jsx(Clock,{size:16,className:\"status-icon pending\"});default:return/*#__PURE__*/_jsx(AlertCircle,{size:16,className:\"status-icon default\"});}};const getStatusText=estado=>{switch(estado){case'confirmado':return'Confirmado';case'listo':return'Listo para recoger';case'pendiente':return'Pendiente';default:return estado;}};return/*#__PURE__*/_jsx(\"div\",{className:\"active-orders-screen\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"orders-header\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"back-button\",onClick:()=>navigate('/main'),children:/*#__PURE__*/_jsx(ArrowLeft,{size:24})}),/*#__PURE__*/_jsx(\"h1\",{children:\"Mis Pedidos Activos\"})]}),!Array.isArray(pedidos)||pedidos.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"empty-state\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"empty-icon\",children:/*#__PURE__*/_jsx(Package,{size:64})}),/*#__PURE__*/_jsx(\"h3\",{children:\"No tienes pedidos activos\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Cuando realices un pedido, aparecer\\xE1 aqu\\xED.\"}),/*#__PURE__*/_jsxs(\"button\",{onClick:()=>navigate('/main'),className:\"btn btn-primary\",children:[/*#__PURE__*/_jsx(ArrowLeft,{size:20}),\"Ver ofertas disponibles\"]})]}):/*#__PURE__*/_jsxs(\"div\",{className:\"orders-content\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"orders-summary\",children:/*#__PURE__*/_jsxs(\"h2\",{children:[\"\\uD83D\\uDCE6 \",pedidos.length,\" \",pedidos.length===1?'pedido activo':'pedidos activos']})}),/*#__PURE__*/_jsx(\"div\",{className:\"orders-list\",children:pedidos.map(pedido=>/*#__PURE__*/_jsxs(\"div\",{className:\"order-card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"order-header\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"order-business\",children:[/*#__PURE__*/_jsx(\"h3\",{children:pedido.comercio_nombre}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-status\",children:[getStatusIcon(pedido.estado),/*#__PURE__*/_jsx(\"span\",{children:getStatusText(pedido.estado)})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-total\",children:[\"$\",pedido.total.toLocaleString('es-CO'),\" COP\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-details\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"order-info\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"info-item\",children:[/*#__PURE__*/_jsx(Package,{size:16}),/*#__PURE__*/_jsxs(\"span\",{children:[pedido.cantidad_packs,\" \",pedido.cantidad_packs===1?'paquete':'paquetes']})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"info-item\",children:[/*#__PURE__*/_jsx(Clock,{size:16}),/*#__PURE__*/_jsxs(\"span\",{children:[\"Recoger: \",new Date(pedido.fecha_recogida).toLocaleString('es-CO',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})]})]})]}),pedido.codigo_seguridad&&/*#__PURE__*/_jsxs(\"div\",{className:\"security-code-card\",onClick:()=>handleCopySecurityCode(pedido.codigo_seguridad),title:\"Click para copiar c\\xF3digo\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"security-code-header\",children:[/*#__PURE__*/_jsx(Shield,{size:18}),/*#__PURE__*/_jsx(\"span\",{children:\"C\\xF3digo de Seguridad\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"security-code-value\",children:pedido.codigo_seguridad}),/*#__PURE__*/_jsx(\"div\",{className:\"security-code-hint\",children:\"\\uD83D\\uDC46 Click para copiar \\u2022 Muestra al comercio\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"order-actions\",children:/*#__PURE__*/_jsxs(\"button\",{onClick:()=>handleVerDetalle(pedido),className:\"btn btn-primary btn-sm\",children:[/*#__PURE__*/_jsx(QrCode,{size:16}),\"Ver QR Verificaci\\xF3n\"]})})]})]},pedido.id))})]})]})});};export default ActiveOrders;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}