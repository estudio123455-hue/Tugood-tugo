{"ast":null,"code":"import React,{useState,useEffect}from'react';import{useNavigate}from'react-router-dom';import{Search,Filter,MapPin,Clock,Euro,Star,Map,List,User,ShoppingCart,Package,Home,Settings,Store}from'lucide-react';import BusinessCard from'../components/BusinessCard';import FilterPanel from'../components/FilterPanel';import MapView from'../components/MapView';import InteractiveMap from'../components/InteractiveMap';import LocationPermissionRequest from'../components/LocationPermissionRequest';import useGeolocation from'../hooks/useGeolocation';import{comerciosAPI,packsAPI,authAPI}from'../services/api';import{mockApiService}from'../services/mockApi';import'../styles/MainScreen.css';import'../styles/InteractiveMap.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const MainScreen=_ref=>{let{user,city,onLogout}=_ref;const navigate=useNavigate();// Debug: verificar usuario\nconsole.log('MainScreen - Usuario recibido:',user);console.log('MainScreen - Tipo de usuario:',user===null||user===void 0?void 0:user.tipo);// Redirigir comercios al panel\nuseEffect(()=>{if(user&&user.tipo==='comercio'){console.log('Usuario es comercio, redirigiendo al panel...');navigate('/merchant-panel');}},[user,navigate]);const[viewMode,setViewMode]=useState('list');// 'list' or 'map'\nconst[showFilters,setShowFilters]=useState(false);const[searchTerm,setSearchTerm]=useState('');const[filters,setFilters]=useState({foodType:'all',maxPrice:50,maxDistance:5,openNow:false});// State for businesses and packs data\nconst[businesses,setBusinesses]=useState([]);const[packs,setPacks]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[filteredBusinesses,setFilteredBusinesses]=useState([]);const[selectedComercio,setSelectedComercio]=useState(null);const[userLocation,setUserLocation]=useState(null);const[showLocationRequest,setShowLocationRequest]=useState(false);const[locationRequested,setLocationRequested]=useState(false);// Hook de geolocalización\nconst{loading:locationLoading,error:locationError,position,permissionStatus,getLocationWithRetry}=useGeolocation();// Load data from API\nuseEffect(()=>{const loadData=async()=>{try{setLoading(true);setError(null);// Load comercios and packs using mock API directly\nconst[comerciosResponse,packsResponse]=await Promise.all([mockApiService.getComercios({limit:50}),mockApiService.getPacks({limit:50})]);// Transform comercios data to match expected format\nconst transformedBusinesses=comerciosResponse.comercios.map(comercio=>{var _comercio$packs;return{id:comercio.id,name:comercio.nombre,type:comercio.tipo_comida,rating:comercio.calificacion||4.5,distance:0.5,originalPrice:15000,discountPrice:8000,itemsAvailable:((_comercio$packs=comercio.packs)===null||_comercio$packs===void 0?void 0:_comercio$packs.length)||2,closingTime:comercio.horario.split(' - ')[1]||'22:00',image:comercio.imagen||'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=300&h=200&fit=crop',coords:comercio.coordenadas||{lat:4.6351,lng:-74.0669},description:comercio.descripcion||'Comercio local',direccion:comercio.direccion,zona:comercio.zona,telefono:comercio.telefono,tiempo_entrega:comercio.tiempo_entrega,costo_envio:comercio.costo_envio,activo:comercio.activo};});setBusinesses(transformedBusinesses);setPacks(packsResponse.packs||[]);}catch(err){console.error('Error loading data:',err);// Cargar datos de fallback si hay error\ntry{const fallbackData=await mockApiService.getComercios();const transformedBusinesses=fallbackData.comercios.map(comercio=>{var _comercio$packs2;return{id:comercio.id,name:comercio.nombre,type:comercio.tipo_comida,rating:comercio.calificacion||4.5,distance:0.5,originalPrice:15000,discountPrice:8000,itemsAvailable:((_comercio$packs2=comercio.packs)===null||_comercio$packs2===void 0?void 0:_comercio$packs2.length)||2,closingTime:'22:00',image:'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=300&h=200&fit=crop',coords:comercio.coordenadas||{lat:4.6351,lng:-74.0669},description:comercio.descripcion,direccion:comercio.direccion,zona:comercio.zona,telefono:comercio.telefono,tiempo_entrega:comercio.tiempo_entrega,costo_envio:comercio.costo_envio,activo:comercio.activo};});setBusinesses(transformedBusinesses);const packsData=await mockApiService.getPacks();setPacks(packsData.packs||[]);setError(null);// Limpiar error si el fallback funciona\n}catch(fallbackErr){console.error('Error with fallback data:',fallbackErr);setError('Error cargando datos. Intenta nuevamente.');}}finally{setLoading(false);}};loadData();},[]);// Manejar geolocalización mejorada\nuseEffect(()=>{const initializeLocation=async()=>{// Si ya tenemos una ubicación, no hacer nada\nif(userLocation)return;// Verificar si ya se denegaron los permisos\nif(permissionStatus==='denied'){setUserLocation({coords:{lat:4.6097,lng:-74.0817},name:(city===null||city===void 0?void 0:city.name)||'Bogotá (ubicación por defecto)'});return;}// Si los permisos están concedidos, obtener ubicación\nif(permissionStatus==='granted'){try{const position=await getLocationWithRetry();setUserLocation({coords:{lat:position.coords.latitude,lng:position.coords.longitude},name:(city===null||city===void 0?void 0:city.name)||'Tu ubicación'});}catch(error){console.warn('Error getting location:',error);setUserLocation({coords:{lat:4.6097,lng:-74.0817},name:(city===null||city===void 0?void 0:city.name)||'Bogotá (ubicación por defecto)'});}}else if(permissionStatus==='prompt'&&!locationRequested){// Mostrar modal para solicitar permisos solo una vez\nsetShowLocationRequest(true);setLocationRequested(true);}};initializeLocation();},[permissionStatus,city,userLocation,getLocationWithRetry]);// Filter businesses based on search and filters\nuseEffect(()=>{// Only filter if we have businesses data\nif(businesses.length===0){setFilteredBusinesses([]);return;}let filtered=businesses;// Apply search filter\nif(searchTerm.trim()){filtered=filtered.filter(business=>business.name.toLowerCase().includes(searchTerm.toLowerCase())||business.type.toLowerCase().includes(searchTerm.toLowerCase())||business.description&&business.description.toLowerCase().includes(searchTerm.toLowerCase()));}// Apply food type filter\nif(filters.foodType!=='all'){filtered=filtered.filter(business=>business.type===filters.foodType);}// Apply price filter (based on available packs)\nif(filters.maxPrice<50&&packs.length>0){const affordablePacks=packs.filter(pack=>pack.precio_descuento<=filters.maxPrice*1000);const affordableComercioIds=[...new Set(affordablePacks.map(pack=>pack.comercio_id))];filtered=filtered.filter(business=>affordableComercioIds.includes(business.id));}// Apply distance filter\nfiltered=filtered.filter(business=>business.distance<=filters.maxDistance);// Apply open now filter\nif(filters.openNow){const now=new Date();const currentTime=now.getHours()*100+now.getMinutes();filtered=filtered.filter(business=>{const closingTime=parseInt(business.closingTime.replace(':',''));return currentTime<closingTime;});}setFilteredBusinesses(filtered);},[searchTerm,filters,businesses,packs]);const handleFilterChange=newFilters=>{setFilters(newFilters);};// Manejar cuando se conceden los permisos de ubicación\nconst handleLocationPermissionGranted=position=>{setUserLocation({coords:{lat:position.coords.latitude,lng:position.coords.longitude},name:(city===null||city===void 0?void 0:city.name)||'Tu ubicación'});setShowLocationRequest(false);};// Manejar cuando se deniegan los permisos\nconst handleLocationPermissionDenied=()=>{setUserLocation({coords:{lat:4.6097,lng:-74.0817},name:(city===null||city===void 0?void 0:city.name)||'Bogotá (ubicación por defecto)'});setShowLocationRequest(false);};// Manejar cuando el usuario decide omitir la ubicación\nconst handleLocationSkip=()=>{setUserLocation({coords:{lat:4.6097,lng:-74.0817},name:(city===null||city===void 0?void 0:city.name)||'Bogotá (ubicación por defecto)'});setShowLocationRequest(false);};return/*#__PURE__*/_jsxs(\"div\",{className:\"main-screen\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"header\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"header-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"location-info\",children:[/*#__PURE__*/_jsx(MapPin,{size:16}),/*#__PURE__*/_jsx(\"span\",{children:(city===null||city===void 0?void 0:city.name)||'Bogotá'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"user-actions\",children:[user&&user.tipo==='comercio'&&/*#__PURE__*/_jsx(\"button\",{className:\"merchant-panel-btn\",onClick:()=>navigate('/merchant-panel'),children:\"\\uD83C\\uDFEA Panel\"}),/*#__PURE__*/_jsx(\"button\",{className:\"user-btn avatar-style\",onClick:()=>navigate('/profile'),children:/*#__PURE__*/_jsx(User,{size:20})})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"main-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"content-header\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Comercios cerca de ti\"}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Encuentra ofertas incre\\xEDbles en \",(city===null||city===void 0?void 0:city.name)||'tu zona']})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"search-bar\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"search-input-container\",children:[/*#__PURE__*/_jsx(Search,{className:\"search-icon\",size:20}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Buscar comercios...\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"search-input\"})]}),/*#__PURE__*/_jsx(\"button\",{className:\"filter-btn\",onClick:()=>setShowFilters(true),children:/*#__PURE__*/_jsx(Filter,{size:20})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"view-toggle\",children:[/*#__PURE__*/_jsxs(\"button\",{className:\"toggle-btn \".concat(viewMode==='list'?'active':''),onClick:()=>setViewMode('list'),children:[/*#__PURE__*/_jsx(List,{size:18}),\"Lista\"]}),/*#__PURE__*/_jsxs(\"button\",{className:\"toggle-btn \".concat(viewMode==='map'?'active':''),onClick:()=>setViewMode('map'),children:[/*#__PURE__*/_jsx(Map,{size:18}),\"Mapa\"]})]}),loading?/*#__PURE__*/_jsxs(\"div\",{className:\"loading-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Cargando comercios...\"})]}):error?/*#__PURE__*/_jsxs(\"div\",{className:\"error-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"error-icon\",children:\"\\u26A0\\uFE0F\"}),/*#__PURE__*/_jsx(\"h3\",{children:\"Error al cargar datos\"}),/*#__PURE__*/_jsx(\"p\",{children:error}),/*#__PURE__*/_jsx(\"button\",{className:\"retry-btn\",onClick:()=>window.location.reload(),children:\"Reintentar\"})]}):viewMode==='list'?/*#__PURE__*/_jsx(\"div\",{className:\"businesses-list\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"results-header\",children:[/*#__PURE__*/_jsxs(\"h2\",{children:[filteredBusinesses.length,\" comercios disponibles\"]}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Cerca de \",city.name]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"businesses-grid\",children:filteredBusinesses.map(business=>/*#__PURE__*/_jsx(BusinessCard,{business:business},business.id))}),filteredBusinesses.length===0&&!loading&&/*#__PURE__*/_jsxs(\"div\",{className:\"no-results\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"no-results-icon\",children:\"\\uD83D\\uDD0D\"}),/*#__PURE__*/_jsx(\"h3\",{children:\"No se encontraron resultados\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Intenta ajustar los filtros o buscar algo diferente\"})]})]})}):/*#__PURE__*/_jsx(\"div\",{className:\"map-container\",children:/*#__PURE__*/_jsx(InteractiveMap,{comercios:businesses,selectedComercio:selectedComercio,onComercioSelect:setSelectedComercio,userLocation:userLocation})})]}),showFilters&&/*#__PURE__*/_jsx(FilterPanel,{filters:filters,onFiltersChange:handleFilterChange,onClose:()=>setShowFilters(false)}),/*#__PURE__*/_jsxs(\"div\",{className:\"bottom-nav\",children:[/*#__PURE__*/_jsxs(\"button\",{className:\"nav-item active\",onClick:()=>navigate('/main'),children:[/*#__PURE__*/_jsx(Home,{size:20}),/*#__PURE__*/_jsx(\"span\",{children:\"Inicio\"})]}),/*#__PURE__*/_jsxs(\"button\",{className:\"nav-item\",onClick:()=>navigate('/cart'),children:[/*#__PURE__*/_jsx(ShoppingCart,{size:20}),/*#__PURE__*/_jsx(\"span\",{children:\"Carrito\"})]}),/*#__PURE__*/_jsxs(\"button\",{className:\"nav-item\",onClick:()=>navigate('/pedidos-activos'),children:[/*#__PURE__*/_jsx(Package,{size:20}),/*#__PURE__*/_jsx(\"span\",{children:\"Pedidos\"})]}),/*#__PURE__*/_jsxs(\"button\",{className:\"nav-item\",onClick:()=>navigate('/profile'),children:[/*#__PURE__*/_jsx(User,{size:20}),/*#__PURE__*/_jsx(\"span\",{children:\"Perfil\"})]}),user&&user.tipo==='comercio'&&/*#__PURE__*/_jsxs(\"button\",{className:\"nav-item\",onClick:()=>navigate('/merchant-panel'),children:[/*#__PURE__*/_jsx(Store,{size:20}),/*#__PURE__*/_jsx(\"span\",{children:\"Panel\"})]})]}),showLocationRequest&&/*#__PURE__*/_jsx(LocationPermissionRequest,{onPermissionGranted:handleLocationPermissionGranted,onPermissionDenied:handleLocationPermissionDenied,onSkip:handleLocationSkip})]});};export default MainScreen;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}