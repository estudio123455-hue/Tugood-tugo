{"ast":null,"code":"import _objectSpread from\"C:/Users/PERSONAL/Downloads/tugood tugo/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{useNavigate}from'react-router-dom';import{ArrowLeft,Minus,Plus,Trash2,MapPin,Clock,CreditCard}from'lucide-react';import{pedidosAPI,pagosAPI,authAPI}from'../services/api';import'../styles/Cart.css';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const Cart=_ref=>{let{user,onOrderComplete}=_ref;const navigate=useNavigate();const[cartItems,setCartItems]=useState([]);const[loading,setLoading]=useState(false);const[paymentMethod,setPaymentMethod]=useState('tarjeta');const[paymentMethods,setPaymentMethods]=useState([]);const[orderComplete,setOrderComplete]=useState(false);const[orderData,setOrderData]=useState(null);// Obtener usuario actual (prop o desde authAPI)\nconst currentUser=user||authAPI.getCurrentUser();// Validación del usuario\nif(!currentUser||!authAPI.isAuthenticated()){return/*#__PURE__*/_jsx(\"div\",{className:\"cart-screen\",children:/*#__PURE__*/_jsx(\"div\",{className:\"container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"error-content\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Error de autenticaci\\xF3n\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Por favor inicia sesi\\xF3n para continuar.\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate('/login'),className:\"btn-primary\",children:\"Iniciar Sesi\\xF3n\"})]})})});}// Calcular totales\nconst subtotal=cartItems.reduce((sum,item)=>sum+(item.price||8000)*item.quantity,0);const serviceFee=Math.round(subtotal*0.1);// 10% tarifa de servicio\nconst total=subtotal+serviceFee;// Load cart from localStorage and payment methods\nuseEffect(()=>{const loadCartAndPaymentMethods=async()=>{// Load cart from localStorage\nconst cart=JSON.parse(localStorage.getItem('tugood_cart')||'[]');setCartItems(cart);// Load payment methods from API\ntry{const methods=await pagosAPI.getPaymentMethods();setPaymentMethods(methods.metodos);}catch(err){console.error('Error loading payment methods:',err);}};loadCartAndPaymentMethods();},[]);// Variables de cálculo ya definidas arriba\nconst updateQuantity=(id,newQuantity)=>{if(newQuantity===0){removeItem(id);return;}const updatedItems=cartItems.map(item=>item.id===id?_objectSpread(_objectSpread({},item),{},{quantity:newQuantity}):item);setCartItems(updatedItems);localStorage.setItem('tugood_cart',JSON.stringify(updatedItems));};const handlePayment=async()=>{if(!paymentMethod){alert('Por favor selecciona un método de pago');return;}if(!currentUser||!currentUser.id){alert('Error: Usuario no autenticado. Por favor inicia sesión nuevamente.');return;}setLoading(true);try{// Generate order data\nconst newOrderData={usuario_id:currentUser.id,comercio_id:cartItems[0].businessId||1,comercio_nombre:cartItems[0].businessName||'Comercio Demo',comercio_direccion:cartItems[0].address||'Dirección demo',comercio_telefono:'+57 300 000 0000',items:cartItems.map(item=>({pack_id:item.id||0,nombre:item.name||'Producto',cantidad:item.quantity||1,precio:item.price||0})),total:total,metodo_pago:paymentMethod,fecha_recogida:cartItems[0].pickupTime||new Date(Date.now()+2*60*60*1000).toISOString()};// Crear pedido en la API\nconst result=await pedidosAPI.create(newOrderData);setOrderData(result.pedido);setOrderComplete(true);// Limpiar carrito\nlocalStorage.removeItem('tugood_cart');setCartItems([]);if(onOrderComplete){onOrderComplete(result.pedido);}}catch(error){console.error('Payment error:',error);alert('Error procesando el pago. Intenta nuevamente.');}finally{setLoading(false);}};if(orderComplete&&orderData){return/*#__PURE__*/_jsx(\"div\",{className:\"cart-screen\",children:/*#__PURE__*/_jsx(\"div\",{className:\"container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"success-content\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"success-icon\",children:\"\\u2705\"}),/*#__PURE__*/_jsx(\"h1\",{children:\"\\xA1Reserva Confirmada!\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Tu pedido ha sido procesado exitosamente\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-section\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"C\\xF3digo de pedido\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-code\",children:[/*#__PURE__*/_jsx(CreditCard,{size:120}),/*#__PURE__*/_jsxs(\"p\",{className:\"order-id\",children:[\"#\",orderData.orderId]})]}),/*#__PURE__*/_jsx(\"p\",{className:\"order-instructions\",children:\"Muestra este c\\xF3digo al comercio para recoger tu pedido\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"pickup-info\",children:[/*#__PURE__*/_jsx(\"h4\",{children:\"Informaci\\xF3n de recogida\"}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Horario:\"}),\" \",orderData.pickupTime]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Direcci\\xF3n:\"}),\" \",orderData.businessAddress]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"success-actions\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-primary\",onClick:()=>navigate('/pedidos-activos'),children:\"Ver mis pedidos\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-secondary\",onClick:()=>navigate('/main'),children:\"Seguir explorando\"})]})]})})});}return/*#__PURE__*/_jsx(\"div\",{className:\"cart-screen\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"cart-header\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"back-button\",onClick:()=>navigate(-1),children:/*#__PURE__*/_jsx(ArrowLeft,{size:24})}),/*#__PURE__*/_jsx(\"h1\",{children:\"Carrito\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"cart-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"order-summary\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Resumen del pedido\"}),cartItems.map(item=>{var _item$originalPrice,_item$price;return/*#__PURE__*/_jsxs(\"div\",{className:\"cart-item\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"item-info\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"https://picsum.photos/80/80?random=\".concat(item.id),alt:item.name,className:\"item-image\",onError:e=>{e.target.src='https://picsum.photos/80/80?random=999';},loading:\"lazy\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"item-text\",children:[/*#__PURE__*/_jsx(\"h3\",{children:item.businessName}),/*#__PURE__*/_jsx(\"p\",{children:item.name}),/*#__PURE__*/_jsxs(\"div\",{className:\"item-details\",children:[/*#__PURE__*/_jsxs(\"span\",{className:\"pickup-time\",children:[\"Recogida: \",item.pickupTime]}),/*#__PURE__*/_jsx(\"span\",{className:\"address\",children:item.address})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"item-pricing\",children:[/*#__PURE__*/_jsxs(\"span\",{className:\"original-price\",children:[\"$\",((_item$originalPrice=item.originalPrice)===null||_item$originalPrice===void 0?void 0:_item$originalPrice.toLocaleString())||'15,000',\" COP\"]}),/*#__PURE__*/_jsxs(\"span\",{className:\"discounted-price\",children:[\"$\",((_item$price=item.price)===null||_item$price===void 0?void 0:_item$price.toLocaleString())||'8,000',\" COP\"]}),/*#__PURE__*/_jsxs(\"div\",{className:\"quantity-controls\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>updateQuantity(item.id,item.quantity-1),children:/*#__PURE__*/_jsx(Minus,{size:16})}),/*#__PURE__*/_jsx(\"span\",{className:\"quantity\",children:item.quantity}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>updateQuantity(item.id,item.quantity+1),children:/*#__PURE__*/_jsx(Plus,{size:16})})]}),/*#__PURE__*/_jsx(\"button\",{className:\"remove-item\",onClick:()=>removeFromCart(item.id),children:/*#__PURE__*/_jsx(Trash2,{size:16})})]})]},item.id);})]}),cartItems.length>0&&/*#__PURE__*/_jsxs(\"div\",{className:\"payment-section\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"M\\xE9todo de Pago\"}),/*#__PURE__*/_jsx(\"div\",{className:\"payment-methods\",children:paymentMethods.map(method=>/*#__PURE__*/_jsxs(\"label\",{className:\"payment-option\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"paymentMethod\",value:method.id,checked:paymentMethod===method.id,onChange:e=>setPaymentMethod(e.target.value)}),/*#__PURE__*/_jsxs(\"div\",{className:\"payment-info\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"payment-name\",children:method.nombre}),/*#__PURE__*/_jsx(\"span\",{className:\"payment-desc\",children:method.descripcion})]})]},method.id))})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"checkout-section\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"total-summary\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"total-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Subtotal\"}),/*#__PURE__*/_jsxs(\"span\",{children:[\"$\",subtotal.toLocaleString(),\" COP\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"total-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Tarifa de servicio (10%)\"}),/*#__PURE__*/_jsxs(\"span\",{children:[\"$\",serviceFee.toLocaleString(),\" COP\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"total-row final\",children:[/*#__PURE__*/_jsx(\"span\",{children:/*#__PURE__*/_jsx(\"strong\",{children:\"Total\"})}),/*#__PURE__*/_jsx(\"span\",{children:/*#__PURE__*/_jsxs(\"strong\",{children:[\"$\",total.toLocaleString(),\" COP\"]})})]})]}),/*#__PURE__*/_jsx(\"button\",{className:\"checkout-button\",onClick:handlePayment,disabled:cartItems.length===0||loading,children:loading?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner small\"}),\"Procesando...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(CreditCard,{size:20}),\"Pagar $\",(total*4000).toLocaleString(),\" COP\"]})})]})]})]})});};export default Cart;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}