{"ast":null,"code":"import _objectSpread from\"C:/Users/PERSONAL/Downloads/tugood tugo/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{useNavigate}from'react-router-dom';import{MapPin,Navigation,LogOut,CheckCircle,RefreshCw}from'lucide-react';import useGeolocation from'../hooks/useGeolocation';import logger from'../utils/logger';import'../styles/LocationScreen.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const LocationScreen=_ref=>{let{user,onLocationSelect,onLogout}=_ref;const[searchTerm,setSearchTerm]=useState('');const[selectedCity,setSelectedCity]=useState(null);const[loading,setLoading]=useState(false);const[showConfirmation,setShowConfirmation]=useState(false);const{loading:geoLoading,getCurrentPosition,findClosestZone}=useGeolocation();const bogotaZones=[{id:1,name:'Chapinero',country:'Bogot√°',coords:{lat:4.6351,lng:-74.0669}},{id:2,name:'Usaqu√©n',country:'Bogot√°',coords:{lat:4.7110,lng:-74.0721}},{id:3,name:'Teusaquillo',country:'Bogot√°',coords:{lat:4.6392,lng:-74.0969}},{id:4,name:'Kennedy',country:'Bogot√°',coords:{lat:4.6280,lng:-74.1372}},{id:5,name:'Zona Rosa',country:'Bogot√°',coords:{lat:4.6486,lng:-74.0648}},{id:6,name:'La Candelaria',country:'Bogot√°',coords:{lat:4.5981,lng:-74.0758}},{id:7,name:'Suba',country:'Bogot√°',coords:{lat:4.7569,lng:-74.0776}},{id:8,name:'Engativ√°',country:'Bogot√°',coords:{lat:4.7110,lng:-74.1469}}];const[filteredCities,setFilteredCities]=useState(bogotaZones);useEffect(()=>{if(searchTerm.trim()){const filtered=bogotaZones.filter(city=>city.name.toLowerCase().includes(searchTerm.toLowerCase())||city.country.toLowerCase().includes(searchTerm.toLowerCase()));setFilteredCities(filtered);}else{setFilteredCities(bogotaZones);}},[searchTerm]);const handleCitySelect=city=>{setSelectedCity(city);};const navigate=useNavigate();const handleConfirmLocation=()=>{if(selectedCity&&!loading){logger.location('Confirmando ubicaci√≥n',selectedCity);setLoading(true);// Verificar que onLocationSelect existe\nif(typeof onLocationSelect==='function'){// Mostrar mensaje de confirmaci√≥n\nsetShowConfirmation(true);// Llamar a onLocationSelect inmediatamente para actualizar el estado\nonLocationSelect(selectedCity);// Esperar un momento para mostrar el mensaje, luego navegar\nsetTimeout(()=>{logger.location('Navegando a MainScreen');navigate('/main');setLoading(false);setShowConfirmation(false);},1500);}else{logger.error('onLocationSelect no es una funci√≥n',onLocationSelect);setLoading(false);alert('Error: No se puede procesar la ubicaci√≥n seleccionada.');}}else if(!selectedCity){alert('Por favor selecciona una zona antes de continuar.');}};const handleUseCurrentLocation=async()=>{setLoading(true);try{logger.location('üîÑ Solicitando ubicaci√≥n GPS actual...');// Obtener ubicaci√≥n r√°pida con configuraci√≥n optimizada\nconst position=await new Promise((resolve,reject)=>{if(!navigator.geolocation){reject(new Error('Tu navegador no soporta geolocalizaci√≥n'));return;}// Primero intentar con configuraci√≥n r√°pida\nnavigator.geolocation.getCurrentPosition(position=>{logger.location('üìç Ubicaci√≥n GPS obtenida:',{lat:position.coords.latitude,lng:position.coords.longitude,accuracy:position.coords.accuracy});resolve(position);},error=>{// Si falla, intentar con configuraci√≥n menos precisa pero m√°s r√°pida\nnavigator.geolocation.getCurrentPosition(position=>{logger.location('üìç Ubicaci√≥n obtenida (modo r√°pido):',{lat:position.coords.latitude,lng:position.coords.longitude,accuracy:position.coords.accuracy});resolve(position);},fallbackError=>{let errorMessage='No se pudo obtener tu ubicaci√≥n GPS. ';switch(fallbackError.code){case 1:// PERMISSION_DENIED\nerrorMessage+='Permisos denegados. Habilita la ubicaci√≥n en tu navegador.';break;case 2:// POSITION_UNAVAILABLE\nerrorMessage+='Ubicaci√≥n no disponible.';break;case 3:// TIMEOUT\nerrorMessage+='Tiempo de espera agotado.';break;default:errorMessage+='Error desconocido.';break;}reject(new Error(errorMessage));},{enableHighAccuracy:false,// Modo r√°pido\ntimeout:5000,// 5 segundos\nmaximumAge:300000// Usar cache de 5 minutos\n});},{enableHighAccuracy:true,// Intentar alta precisi√≥n primero\ntimeout:8000,// 8 segundos m√°ximo\nmaximumAge:60000// Cache de 1 minuto\n});});const{latitude,longitude}=position.coords;// Obtener direcci√≥n usando geocodificaci√≥n inversa (optimizada)\nlet address='Direcci√≥n no disponible';// Hacer la geocodificaci√≥n en paralelo, no bloquear la UI\nconst geocodePromise=(async()=>{try{logger.location('üîç Obteniendo direcci√≥n...');const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),3000);// 3 segundos timeout\nconst response=await fetch(\"https://maps.googleapis.com/maps/api/geocode/json?latlng=\".concat(latitude,\",\").concat(longitude,\"&key=\").concat(process.env.REACT_APP_GOOGLE_MAPS_API_KEY,\"&language=es&region=CO&result_type=street_address|route\"),{signal:controller.signal});clearTimeout(timeoutId);if(response.ok){const data=await response.json();if(data.results&&data.results.length>0){const result=data.results[0];address=result.formatted_address.replace(', Colombia','').replace(', Bogot√°','');logger.location('üìç Direcci√≥n obtenida:',address);return address;}}}catch(error){if(error.name!=='AbortError'){logger.warn('Error obteniendo direcci√≥n:',error.message);}}return'Direcci√≥n no disponible';})();// Encontrar la zona m√°s cercana inmediatamente\nconst closestZone=findClosestZone(bogotaZones,latitude,longitude);if(closestZone){// Crear el objeto de ubicaci√≥n inmediatamente\nconst currentLocationCity={id:'current',name:\"\".concat(closestZone.name,\" (Tu ubicaci\\xF3n GPS)\"),country:'Bogot√°',coords:{lat:latitude,lng:longitude},accuracy:position.coords.accuracy,timestamp:new Date().toISOString(),address:'Obteniendo direcci√≥n...'// Placeholder mientras se obtiene\n};logger.location('‚úÖ Ubicaci√≥n GPS configurada:',currentLocationCity);setSelectedCity(currentLocationCity);// Mostrar confirmaci√≥n inmediata\nconst precisionText=position.coords.accuracy<=20?\"\\uD83C\\uDFAF Precisi\\xF3n: \".concat(Math.round(position.coords.accuracy),\"m (Excelente)\"):position.coords.accuracy<=50?\"\\uD83C\\uDFAF Precisi\\xF3n: \".concat(Math.round(position.coords.accuracy),\"m (Buena)\"):\"\\uD83C\\uDFAF Precisi\\xF3n: \".concat(Math.round(position.coords.accuracy),\"m (Aproximada)\");alert(\"\\uD83D\\uDCCD Ubicaci\\xF3n GPS obtenida exitosamente!\\n\\n\\uD83D\\uDCCD Zona: \".concat(closestZone.name,\"\\n\").concat(precisionText,\"\\n\\uD83C\\uDFE0 Obteniendo direcci\\xF3n...\"));// Actualizar con la direcci√≥n cuando est√© lista (no bloquear)\ngeocodePromise.then(finalAddress=>{if(finalAddress!=='Direcci√≥n no disponible'){setSelectedCity(prev=>_objectSpread(_objectSpread({},prev),{},{address:finalAddress}));}else{setSelectedCity(prev=>_objectSpread(_objectSpread({},prev),{},{address:'Direcci√≥n no disponible'}));}});}}catch(error){logger.error('‚ùå Error obteniendo ubicaci√≥n GPS:',error.message);// Fallback to Chapinero if geolocation fails\nconst fallbackCity={id:'fallback',name:'Chapinero (Zona por defecto)',country:'Bogot√°',coords:{lat:4.6351,lng:-74.0669}};setSelectedCity(fallbackCity);alert(error.message+'\\n\\nSe seleccion√≥ Chapinero como zona por defecto.');}finally{setLoading(false);}};return/*#__PURE__*/_jsx(\"div\",{className:\"location-screen\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"location-header\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"back-btn\",onClick:onLogout,children:/*#__PURE__*/_jsx(LogOut,{size:24})}),/*#__PURE__*/_jsx(\"div\",{className:\"user-info\",children:/*#__PURE__*/_jsxs(\"span\",{children:[\"Hola, \",(user===null||user===void 0?void 0:user.name)||'Usuario']})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"location-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"location-title\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\xBFD\\xF3nde est\\xE1s?\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Selecciona tu ciudad para encontrar ofertas cercanas\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"location-actions\",children:/*#__PURE__*/_jsxs(\"button\",{className:\"btn btn-primary current-location-btn\",onClick:handleUseCurrentLocation,disabled:loading||geoLoading,children:[/*#__PURE__*/_jsx(Navigation,{size:20}),loading||geoLoading?'Obteniendo ubicaci√≥n GPS...':'Usar mi ubicaci√≥n actual']})}),/*#__PURE__*/_jsx(\"div\",{className:\"location-actions\",children:/*#__PURE__*/_jsxs(\"button\",{className:\"btn btn-secondary refresh-location-btn\",onClick:handleUseCurrentLocation,disabled:loading||geoLoading,title:\"Obtener ubicaci\\xF3n GPS fresca\",children:[/*#__PURE__*/_jsx(RefreshCw,{size:20}),loading||geoLoading?'Actualizando GPS...':'Actualizar ubicaci√≥n GPS']})}),/*#__PURE__*/_jsx(\"div\",{className:\"search-section\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"search-input-container\",children:[/*#__PURE__*/_jsx(MapPin,{className:\"search-icon\",size:20}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Buscar zona...\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"input search-input\"})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"cities-section\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"Zonas de Bogot\\xE1\"}),/*#__PURE__*/_jsx(\"div\",{className:\"cities-grid\",children:filteredCities.map(city=>/*#__PURE__*/_jsxs(\"button\",{className:\"city-card \".concat((selectedCity===null||selectedCity===void 0?void 0:selectedCity.id)===city.id?'selected':''),onClick:()=>handleCitySelect(city),children:[/*#__PURE__*/_jsx(MapPin,{size:20,className:\"city-icon\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"city-info\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"city-name\",children:city.name}),/*#__PURE__*/_jsx(\"span\",{className:\"city-country\",children:city.country})]})]},city.id))})]}),selectedCity&&/*#__PURE__*/_jsxs(\"div\",{className:\"selected-location\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"selected-info\",children:[/*#__PURE__*/_jsx(MapPin,{size:20}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:selectedCity.name}),/*#__PURE__*/_jsx(\"span\",{children:selectedCity.country}),selectedCity.address&&/*#__PURE__*/_jsxs(\"span\",{className:\"selected-address \".concat(selectedCity.address==='Obteniendo direcci√≥n...'?'loading':''),children:[\"\\uD83D\\uDCCD \",selectedCity.address]})]})]}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-primary confirm-btn\",onClick:handleConfirmLocation,disabled:loading,children:loading?'Confirmando...':'Confirmar ubicaci√≥n'})]}),showConfirmation&&/*#__PURE__*/_jsx(\"div\",{className:\"confirmation-message\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"confirmation-content\",children:[/*#__PURE__*/_jsx(CheckCircle,{size:32,className:\"confirmation-icon\"}),/*#__PURE__*/_jsx(\"h3\",{children:\"\\xA1Ubicaci\\xF3n confirmada!\"}),/*#__PURE__*/_jsx(\"p\",{children:selectedCity===null||selectedCity===void 0?void 0:selectedCity.name}),/*#__PURE__*/_jsxs(\"div\",{className:\"loading-dots\",children:[/*#__PURE__*/_jsx(\"span\",{}),/*#__PURE__*/_jsx(\"span\",{}),/*#__PURE__*/_jsx(\"span\",{})]})]})})]})]})});};// PropTypes validation\nexport default LocationScreen;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}