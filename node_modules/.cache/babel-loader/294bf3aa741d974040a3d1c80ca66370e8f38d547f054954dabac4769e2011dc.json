{"ast":null,"code":"import React,{useState,useEffect}from'react';import{BrowserRouter as Router,Routes,Route,Navigate}from'react-router-dom';import LoginScreen from'./pages/LoginScreen';import LocationScreen from'./pages/LocationScreen';import MainScreen from'./pages/MainScreen';import OfferDetail from'./pages/OfferDetail';import Cart from'./pages/Cart';import MyOrders from'./pages/MyOrders';import ActiveOrders from'./pages/ActiveOrders';import Profile from'./pages/Profile';import RestaurantConfirmation from'./pages/RestaurantConfirmation';import OrderVerification from'./pages/OrderVerification';import EmailVerification from'./pages/EmailVerification';import MerchantPanel from'./pages/MerchantPanel';import MerchantDashboard from'./pages/MerchantDashboard';import ProtectedRoute from'./components/ProtectedRoute';import{authAPI}from'./services/api';import logger from'./utils/logger';import{ToastContainer,toast}from'react-toastify';import'react-toastify/dist/ReactToastify.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function App(){const[user,setUser]=useState(null);const[selectedCity,setSelectedCity]=useState(null);const[authChecked,setAuthChecked]=useState(false);useEffect(()=>{// Check for existing user session only once on mount\nconsole.log('App: Verificando sesión existente...');const savedUser=authAPI.getCurrentUser();const savedCity=localStorage.getItem('tugood_city');console.log('App: Usuario guardado:',!!savedUser);console.log('App: Está autenticado:',authAPI.isAuthenticated());if(savedUser&&authAPI.isAuthenticated()){console.log('App: Restaurando sesión de usuario');setUser(savedUser);}else{console.log('App: No hay sesión válida');// Limpiar datos inconsistentes\nauthAPI.logout();}if(savedCity){try{setSelectedCity(JSON.parse(savedCity));console.log('App: Ciudad restaurada:',JSON.parse(savedCity).name);}catch(e){console.log('App: Error al parsear ciudad, eliminando');localStorage.removeItem('tugood_city');}}setAuthChecked(true);console.log('App: Verificación de autenticación completada');},[]);const handleLogin=userData=>{setUser(userData);// Token and user data are already saved in authAPI.login\n// Don't navigate here - let the routing logic handle it\n};const handleLocationSelect=cityData=>{logger.location('handleLocationSelect llamado',cityData);// Evitar múltiples ejecuciones con la misma ciudad\nif(selectedCity&&selectedCity.id===cityData.id){logger.debug('Ciudad ya seleccionada, ignorando');return;}// Show toast notification for location change (only for automatic changes, not manual confirmation)\nif(selectedCity&&cityData.id!=='current'&&cityData.id!=='fallback'){toast.info(\"\\uD83D\\uDCCD Tu ubicaci\\xF3n cambi\\xF3 a \".concat(cityData.name),{position:\"top-center\",autoClose:3000,hideProgressBar:false,closeOnClick:true,pauseOnHover:true,draggable:true});}logger.info(\"Actualizando ciudad de: \".concat(selectedCity===null||selectedCity===void 0?void 0:selectedCity.name,\" a: \").concat(cityData.name));setSelectedCity(cityData);localStorage.setItem('tugood_city',JSON.stringify(cityData));logger.info('Ciudad actualizada y guardada');};const handleLogout=()=>{setUser(null);setSelectedCity(null);authAPI.logout();localStorage.removeItem('tugood_city');};return/*#__PURE__*/_jsxs(\"div\",{className:\"App\",children:[/*#__PURE__*/_jsx(Router,{future:{v7_startTransition:true,v7_relativeSplatPath:true},children:/*#__PURE__*/_jsxs(Routes,{children:[/*#__PURE__*/_jsx(Route,{path:\"/login\",element:!authChecked?/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',justifyContent:'center',alignItems:'center',height:'100vh'},children:/*#__PURE__*/_jsx(\"div\",{children:\"Cargando...\"})}):user?/*#__PURE__*/_jsx(Navigate,{to:selectedCity?\"/main\":\"/location\",replace:true}):/*#__PURE__*/_jsx(LoginScreen,{onLogin:handleLogin})}),/*#__PURE__*/_jsx(Route,{path:\"/\",element:!authChecked?/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',justifyContent:'center',alignItems:'center',height:'100vh'},children:/*#__PURE__*/_jsx(\"div\",{children:\"Cargando...\"})}):!user?/*#__PURE__*/_jsx(Navigate,{to:\"/login\",replace:true}):!selectedCity?/*#__PURE__*/_jsx(Navigate,{to:\"/location\",replace:true}):/*#__PURE__*/_jsx(Navigate,{to:\"/main\",replace:true})}),/*#__PURE__*/_jsx(Route,{path:\"/location\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:/*#__PURE__*/_jsx(LocationScreen,{user:user,onLocationSelect:handleLocationSelect,onLogout:handleLogout})})}),/*#__PURE__*/_jsx(Route,{path:\"/main\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:selectedCity?(user===null||user===void 0?void 0:user.tipo)==='comercio'?/*#__PURE__*/_jsx(MerchantDashboard,{user:user,city:selectedCity,onLogout:handleLogout}):/*#__PURE__*/_jsx(MainScreen,{user:user,city:selectedCity,onLogout:handleLogout}):/*#__PURE__*/_jsx(Navigate,{to:\"/location\",replace:true})})}),/*#__PURE__*/_jsx(Route,{path:\"/offer/:offerId\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:/*#__PURE__*/_jsx(OfferDetail,{user:user,onReserve:offer=>console.log('Reserva realizada:',offer)})})}),/*#__PURE__*/_jsx(Route,{path:\"/cart\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:/*#__PURE__*/_jsx(Cart,{user:user,onOrderComplete:order=>console.log('Pedido completado:',order)})})}),/*#__PURE__*/_jsx(Route,{path:\"/pedidos\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:/*#__PURE__*/_jsx(MyOrders,{user:user})})}),/*#__PURE__*/_jsx(Route,{path:\"/pedidos-activos\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:/*#__PURE__*/_jsx(ActiveOrders,{})})}),/*#__PURE__*/_jsx(Route,{path:\"/profile\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:/*#__PURE__*/_jsx(Profile,{user:user,onLogout:handleLogout})})}),/*#__PURE__*/_jsx(Route,{path:\"/restaurant/confirm/:orderData\",element:/*#__PURE__*/_jsx(RestaurantConfirmation,{})}),/*#__PURE__*/_jsx(Route,{path:\"/verificar/:encodedData\",element:/*#__PURE__*/_jsx(OrderVerification,{})}),/*#__PURE__*/_jsx(Route,{path:\"/email-verification\",element:/*#__PURE__*/_jsx(EmailVerification,{})}),/*#__PURE__*/_jsx(Route,{path:\"/merchant-panel\",element:/*#__PURE__*/_jsx(ProtectedRoute,{children:/*#__PURE__*/_jsx(MerchantPanel,{user:user})})})]})}),/*#__PURE__*/_jsx(ToastContainer,{position:\"top-center\",autoClose:3000,hideProgressBar:false,newestOnTop:false,closeOnClick:true,rtl:false,pauseOnFocusLoss:true,draggable:true,pauseOnHover:true,theme:\"light\"})]});}export default App;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}